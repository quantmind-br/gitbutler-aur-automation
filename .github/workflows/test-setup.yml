name: Test Setup

on:
  workflow_dispatch:

jobs:
  test-environment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test basic setup
        run: |
          echo "✅ Repository checkout successful"
          echo "📂 Current directory: $(pwd)"
          echo "📋 Files:"
          ls -la

      - name: Test Python setup
        run: |
          echo "🐍 Python version: $(python3 --version)"
          echo "📦 Testing scripts:"
          python3 -c "print('Python is working!')"

      - name: Check secrets availability
        env:
          HAS_SSH_KEY: ${{ secrets.AUR_SSH_KEY != '' }}
          HAS_DISCORD: ${{ secrets.DISCORD_WEBHOOK != '' }}
        run: |
          echo "🔐 Secret status:"
          echo "  - AUR_SSH_KEY: $HAS_SSH_KEY"
          echo "  - DISCORD_WEBHOOK: $HAS_DISCORD"

          if [ "$HAS_SSH_KEY" = "true" ]; then
            echo "✅ SSH key is configured"
          else
            echo "❌ SSH key missing - Add AUR_SSH_KEY secret"
          fi

      - name: Test SSH setup (if key available)
        if: secrets.AUR_SSH_KEY != ''
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          echo "🔧 Setting up SSH..."
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

          cat >> ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            HostName aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/id_ed25519
            IdentitiesOnly yes
          EOF

          echo "🧪 Testing SSH connection..."
          ssh -T aur@aur.archlinux.org || echo "SSH test completed (expected to fail in non-interactive mode)"
          echo "✅ SSH setup successful"

      - name: Test update script
        run: |
          echo "🧪 Testing update check script..."
          if python3 check_updates.py; then
            echo "✅ Update script works"
          else
            echo "⚠️ Update script had issues (may be expected)"
          fi

      - name: Summary
        env:
          HAS_SSH_KEY: ${{ secrets.AUR_SSH_KEY != '' }}
        run: |
          echo ""
          echo "📋 SETUP STATUS SUMMARY"
          echo "======================"
          echo ""

          if [ "$HAS_SSH_KEY" = "true" ]; then
            echo "✅ Ready for automation!"
            echo "   - SSH key configured"
            echo "   - Scripts working"
            echo "   - Can proceed with AUR updates"
          else
            echo "⚠️ Setup incomplete:"
            echo "   - Missing AUR_SSH_KEY secret"
            echo "   - Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   - Add your SSH private key as AUR_SSH_KEY"
          fi